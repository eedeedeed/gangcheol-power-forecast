<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG 서비스 - 회원가입/로그인/예측</title>
    <style>
        /* 기본적인 CSS 스타일링으로 페이지를 보기 좋게 만듭니다. */
        body {
            font-family: Arial, sans-serif;
            display: flex; /* Flexbox를 사용하여 요소들을 중앙에 정렬합니다. */
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 뷰포트 높이의 100%를 차지하도록 합니다. */
            background-color: #f4f4f4; /* 배경색 */
            margin: 0;
            flex-direction: column; /* 요소들을 세로로 정렬합니다. */
        }
        .container {
            background-color: #fff; /* 컨테이너 배경색 */
            padding: 20px 30px; /* 내부 여백 */
            border-radius: 8px; /* 모서리 둥글게 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
            width: 300px; /* 너비 고정 */
            margin: 10px; /* 컨테이너 간의 외부 여백 */
        }
        h2 {
            text-align: center; /* 제목 중앙 정렬 */
            color: #333; /* 제목 색상 */
            margin-bottom: 20px; /* 제목 아래 여백 */
        }
        .form-group {
            margin-bottom: 15px; /* 폼 그룹 아래 여백 */
        }
        label {
            display: block; /* 라벨을 블록 요소로 만들어 줄 바꿈 */
            margin-bottom: 5px; /* 라벨 아래 여백 */
            color: #555; /* 라벨 색상 */
        }
        input[type="text"],
        input[type="password"] {
            width: calc(100% - 20px); /* 너비 100%에서 패딩 값 제외 */
            padding: 10px; /* 입력 필드 내부 여백 */
            border: 1px solid #ddd; /* 테두리 */
            border-radius: 4px; /* 모서리 둥글게 */
            box-sizing: border-box; /* 패딩과 보더가 너비에 포함되도록 설정 */
        }
        button {
            width: 100%; /* 버튼 너비 100% */
            padding: 10px; /* 버튼 내부 여백 */
            background-color: #007bff; /* 버튼 배경색 */
            color: white; /* 버튼 글자색 */
            border: none; /* 테두리 없음 */
            border-radius: 4px; /* 모서리 둥글게 */
            cursor: pointer; /* 마우스 오버 시 커서 변경 */
            font-size: 16px; /* 글자 크기 */
            margin-top: 5px; /* 버튼 위 여백 */
        }
        button:hover {
            background-color: #0056b3; /* 마우스 오버 시 배경색 변경 */
        }
        .message {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        .success-message {
            color: green;
        }
        .error-message {
            color: red;
        }
        pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap; /* 긴 텍스트 줄 바꿈 */
            word-wrap: break-word; /* 단어 단위 줄 바꿈 */
            text-align: left;
            max-height: 200px; /* 최대 높이 설정 */
            overflow-y: auto; /* 내용이 많으면 스크롤바 생성 */
        }
    </style>
</head>
<body>

    <!-- 회원가입 섹션 -->
    <div class="container">
        <h2>회원가입</h2>
        <div class="form-group">
            <label for="registerUsername">사용자 이름:</label>
            <input type="text" id="registerUsername" placeholder="사용자 이름">
        </div>
        <div class="form-group">
            <label for="registerPassword">비밀번호:</label>
            <input type="password" id="registerPassword" placeholder="비밀번호">
        </div>
        <button onclick="registerUser()">회원가입</button>
        <p id="registerMessage" class="message success-message"></p>
        <p id="registerError" class="message error-message"></p>
    </div>

    <!-- 로그인 섹션 -->
    <div class="container">
        <h2>로그인</h2>
        <div class="form-group">
            <label for="loginUsername">사용자 이름:</label>
            <input type="text" id="loginUsername" placeholder="사용자 이름">
        </div>
        <div class="form-group">
            <label for="loginPassword">비밀번호:</label>
            <input type="password" id="loginPassword" placeholder="비밀번호">
        </div>
        <button onclick="loginUser()">로그인</button>
        <p id="loginMessage" class="message success-message"></p>
        <p id="loginError" class="message error-message"></p>
    </div>

    <!-- 리포트 생성 섹션 -->
    <div class="container">
        <h2>리포트 생성 (로그인 필요)</h2>
        <div class="form-group">
            <label for="reportTitle">제목:</label>
            <input type="text" id="reportTitle" placeholder="리포트 제목">
        </div>
        <div class="form-group">
            <label for="reportContent">내용:</label>
            <input type="text" id="reportContent" placeholder="리포트 내용">
        </div>
        <div class="form-group">
            <label for="energyUsage">에너지 사용량 (kWh):</label>
            <input type="text" id="energyUsage" placeholder="예: 123.45">
        </div>
        <div class="form-group">
            <label for="carbonEmission">탄소 배출량 (kgCO2):</label>
            <input type="text" id="carbonEmission" placeholder="예: 67.89">
        </div>
        <button onclick="createReport()">리포트 생성</button>
        <p id="reportMessage" class="message success-message"></p>
        <p id="reportError" class="message error-message"></p>
    </div>

    <!-- 모든 리포트 조회 섹션 -->
    <div class="container">
        <h2>모든 리포트 조회 (로그인 필요)</h2>
        <button onclick="getAllReports()">리포트 가져오기</button>
        <p id="allReportsMessage" class="message success-message"></p>
        <p id="allReportsError" class="message error-message"></p>
        <pre id="allReportsDisplay"></pre>
    </div>

    <!-- AI 예측 섹션 -->
    <div class="container">
        <h2>전력 사용량 예측 (로그인 필요)</h2>
        <div class="form-group">
            <label for="predictBuildingNumber">건물 번호:</label>
            <input type="text" id="predictBuildingNumber" value="1" placeholder="예: 1">
        </div>
        <div class="form-group">
            <label for="predictTemperature">기온 (°C):</label>
            <input type="text" id="predictTemperature" value="25.5" placeholder="예: 25.5">
        </div>
        <div class="form-group">
            <label for="predictHumidity">습도 (%):</label>
            <input type="text" id="predictHumidity" value="60" placeholder="예: 60">
        </div>
        <div class="form-group">
            <label for="predictHour">시간 (0-23):</label>
            <input type="text" id="predictHour" value="14" placeholder="예: 14">
        </div>
        <button onclick="predictPower()">전력 사용량 예측</button>
        <p id="predictMessage" class="message success-message"></p>
        <p id="predictError" class="message error-message"></p>
        <pre id="predictDisplay"></pre>
    </div>

    <script>
        // 백엔드 서버의 기본 URL을 정의합니다.
        const API_BASE_URL = 'http://localhost:3000/api';

        // 로그인 성공 시 서버로부터 받은 JWT 토큰을 저장할 변수입니다.
        // 이 토큰은 인증이 필요한 API 요청 시 사용됩니다.
        let authToken = null;

        /**
         * 메시지를 화면에 표시하는 유틸리티 함수입니다.
         * @param {HTMLElement} element - 메시지를 표시할 HTML 요소
         * @param {string} message - 표시할 메시지 텍스트
         * @param {boolean} isError - 오류 메시지인지 여부 (true면 빨간색, false면 초록색)
         */
        function displayMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = 'message ' + (isError ? 'error-message' : 'success-message');
        }

        /**
         * 회원가입 API를 호출하는 함수입니다.
         */
        async function registerUser() {
            // 입력 필드에서 사용자 이름과 비밀번호를 가져옵니다.
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            // 메시지를 표시할 HTML 요소를 가져옵니다.
            const messageElem = document.getElementById('registerMessage');
            const errorElem = document.getElementById('registerError');
            // 이전 메시지를 초기화합니다.
            messageElem.textContent = '';
            errorElem.textContent = '';

            try {
                // fetch API를 사용하여 백엔드의 회원가입 엔드포인트에 POST 요청을 보냅니다.
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST', // HTTP POST 메서드
                    headers: {
                        'Content-Type': 'application/json' // 요청 본문이 JSON 형식임을 알립니다.
                    },
                    body: JSON.stringify({ username, password }) // JavaScript 객체를 JSON 문자열로 변환하여 보냅니다.
                });

                // 서버 응답을 JSON 형식으로 파싱합니다.
                const data = await response.json();

                // 응답 상태가 성공(2xx)이면
                if (response.ok) {
                    displayMessage(messageElem, data.message + ` (ID: ${data.userId})`);
                } else {
                    // 응답 상태가 오류(4xx, 5xx)이면
                    displayMessage(errorElem, data.error || '회원가입 실패', true);
                }
            } catch (error) {
                // 네트워크 오류 등 요청 자체에 문제가 발생한 경우
                console.error('회원가입 네트워크 에러:', error);
                displayMessage(errorElem, '네트워크 오류 발생', true);
            }
        }

        /**
         * 로그인 API를 호출하는 함수입니다.
         */
        async function loginUser() {
            // 입력 필드에서 사용자 이름과 비밀번호를 가져옵니다.
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            // 메시지를 표시할 HTML 요소를 가져옵니다.
            const messageElem = document.getElementById('loginMessage');
            const errorElem = document.getElementById('loginError');
            // 이전 메시지를 초기화합니다.
            messageElem.textContent = '';
            errorElem.textContent = '';

            try {
                // fetch API를 사용하여 백엔드의 로그인 엔드포인트에 POST 요청을 보냅니다.
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                // 응답 상태가 성공(2xx)이면
                if (response.ok) {
                    displayMessage(messageElem, data.message);
                    authToken = data.token; // 로그인 성공 시 받은 JWT 토큰을 저장합니다.
                    console.log('로그인 성공, 토큰:', authToken); // 개발자 도구 콘솔에 토큰 출력
                } else {
                    // 응답 상태가 오류(4xx, 5xx)이면
                    displayMessage(errorElem, data.error || '로그인 실패', true);
                }
            } catch (error) {
                // 네트워크 오류 등 요청 자체에 문제가 발생한 경우
                console.error('로그인 네트워크 에러:', error);
                displayMessage(errorElem, '네트워크 오류 발생', true);
            }
        }

        /**
         * 리포트 생성 API를 호출하는 함수입니다. (로그인 필요)
         */
        async function createReport() {
            // 입력 필드에서 리포트 정보를 가져옵니다.
            const title = document.getElementById('reportTitle').value;
            const content = document.getElementById('reportContent').value;
            const energyUsage = parseFloat(document.getElementById('energyUsage').value); // 숫자로 변환
            const carbonEmission = parseFloat(document.getElementById('carbonEmission').value); // 숫자로 변환

            // 메시지를 표시할 HTML 요소를 가져옵니다.
            const messageElem = document.getElementById('reportMessage');
            const errorElem = document.getElementById('reportError');
            // 이전 메시지를 초기화합니다.
            messageElem.textContent = '';
            errorElem.textContent = '';

            // JWT 토큰이 없으면 리포트 생성을 시도하지 않고 오류 메시지를 표시합니다.
            if (!authToken) {
                displayMessage(errorElem, '리포트 생성을 위해 로그인이 필요합니다.', true);
                return;
            }

            try {
                // fetch API를 사용하여 백엔드의 리포트 생성 엔드포인트에 POST 요청을 보냅니다.
                const response = await fetch(`${API_BASE_URL}/reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` // JWT 토큰을 Authorization 헤더에 포함하여 보냅니다.
                    },
                    body: JSON.stringify({ title, content, energyUsage, carbonEmission })
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(messageElem, data.message + ` (ID: ${data.reportId})`);
                } else {
                    displayMessage(errorElem, data.error || '리포트 생성 실패', true);
                }
            } catch (error) {
                console.error('리포트 생성 네트워크 에러:', error);
                displayMessage(errorElem, '네트워크 오류 발생', true);
            }
        }

        /**
         * 모든 리포트 조회 API를 호출하는 함수입니다. (로그인 필요)
         */
        async function getAllReports() {
            // 메시지를 표시할 HTML 요소를 가져옵니다.
            const messageElem = document.getElementById('allReportsMessage');
            const errorElem = document.getElementById('allReportsError');
            const displayElem = document.getElementById('allReportsDisplay');
            // 이전 메시지 및 표시 내용을 초기화합니다.
            messageElem.textContent = '';
            errorElem.textContent = '';
            displayElem.textContent = '';

            // JWT 토큰이 없으면 리포트 조회를 시도하지 않고 오류 메시지를 표시합니다.
            if (!authToken) {
                displayMessage(errorElem, '리포트 조회를 위해 로그인이 필요합니다.', true);
                return;
            }

            try {
                // fetch API를 사용하여 백엔드의 모든 리포트 조회 엔드포인트에 GET 요청을 보냅니다.
                const response = await fetch(`${API_BASE_URL}/reports`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}` // JWT 토큰을 Authorization 헤더에 포함
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(messageElem, '리포트 조회 성공');
                    // 조회된 리포트 데이터를 JSON 문자열로 변환하여 <pre> 태그에 표시합니다.
                    displayElem.textContent = JSON.stringify(data, null, 2);
                } else {
                    displayMessage(errorElem, data.error || '리포트 조회 실패', true);
                }
            } catch (error) {
                console.error('모든 리포트 조회 네트워크 에러:', error);
                displayMessage(errorElem, '네트워크 오류 발생', true);
            }
        }

        /**
         * AI 예측 API를 호출하는 함수입니다. (로그인 필요)
         */
        async function predictPower() {
            // 입력 필드에서 예측에 필요한 데이터를 가져옵니다.
            const building_number = parseInt(document.getElementById('predictBuildingNumber').value);
            const temperature = parseFloat(document.getElementById('predictTemperature').value);
            const humidity = parseFloat(document.getElementById('predictHumidity').value);
            const hour = parseInt(document.getElementById('predictHour').value);

            // 메시지를 표시할 HTML 요소를 가져옵니다.
            const messageElem = document.getElementById('predictMessage');
            const errorElem = document.getElementById('predictError');
            const displayElem = document.getElementById('predictDisplay');
            // 이전 메시지 및 표시 내용을 초기화합니다.
            messageElem.textContent = '';
            errorElem.textContent = '';
            displayElem.textContent = '';

            // JWT 토큰이 없으면 예측을 시도하지 않고 오류 메시지를 표시합니다.
            if (!authToken) {
                displayMessage(errorElem, '전력 사용량 예측을 위해 로그인이 필요합니다.', true);
                return;
            }

            // 입력값 유효성 검사 (간단하게)
            if (isNaN(building_number) || isNaN(temperature) || isNaN(humidity) || isNaN(hour)) {
                displayMessage(errorElem, '모든 예측 입력값을 올바르게 입력해주세요.', true);
                return;
            }

            try {
                // fetch API를 사용하여 백엔드의 예측 엔드포인트에 POST 요청을 보냅니다.
                const response = await fetch(`${API_BASE_URL}/predictions/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` // JWT 토큰을 Authorization 헤더에 포함
                    },
                    body: JSON.stringify({
                        building_number,
                        temperature,
                        humidity,
                        hour,
                        // 실제 AI 모델에 필요한 다른 특성들도 여기에 추가합니다.
                        // 예: date: new Date().toISOString().split('T')[0],
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(messageElem, data.message);
                    // 예측 결과를 <pre> 태그에 표시합니다.
                    displayElem.textContent = `예측 전력 사용량: ${data.predicted_consumption_kwh.toFixed(2)} kWh`;
                    console.log('예측 결과:', data);
                } else {
                    displayMessage(errorElem, data.error || '전력 사용량 예측 실패', true);
                }
            } catch (error) {
                console.error('전력 사용량 예측 네트워크 에러:', error);
                displayMessage(errorElem, '네트워크 오류 발생', true);
            }
        }
    </script>
</body>
</html>
